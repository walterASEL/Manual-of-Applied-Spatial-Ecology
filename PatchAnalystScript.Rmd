---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Fragstats Metrics within Buffers

Some research designs may just need landscape metrics for a single area or several study areas and that is what the SDMToolsl package is able to estimate in the code that follows. While the single area can be defined by the extent of the raster we imported as in previous chapters, the ability of the SDMToolsl package to determine patch and class statistics depends on the area defined by the user from that could be study site, within polygons such as counties or townships, or within buffers around locations.

1\. Open the script "PatchAnalystScript.Rmd" and run code directly from the script

2\. First we need to load the packages needed for the exercise

```{r warning=FALSE, message=FALSE}
#library(SDMTools)
library(plyr)
library(landscapemetrics)
library(sf)
library(terra)
```

3\. Now let's have a separate section of code to include projection information we will use throughout the exercise. In previous versions, these lines of code were within each block of code

```{r warning=FALSE, message=FALSE}
ll.crs <- st_crs(4269)
utm.crs <- st_crs(26912)
albers.crs <- st_crs(5070)
```

4\. Load vegetation raster layer created previoulsy. NOTE: The Cropland data layer for this region of Colorado was not available for 2011.

```{r}
crops <-rast("data/crop2012utm12.tif")

# reclassify the values into 9 groups
# all values between 0 and 20 equal 1, etc.
m <- c(-Inf,0,NA,2, 7, 2, 20, 60, 3, 60, 70, 4, 110, 132, 5, 133, 150, 6, 151, 191, 7, 
  192,Inf,NA)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
rc <- classify(crops, rclmat)
plot(rc)
```

5.  What if we wanted to compare difference in patch statistics among all deer with all locations combined?

We will start by creating buffers around individual locations for our mule deer dataset

```{r warning=FALSE, message=FALSE}
muleys <-read.csv("data/muleysexample.csv", header=T)

muleys$GPSFixTime<-as.POSIXct(muleys$GPSFixTime, format="%Y.%m.%d%H:%M:%S")

coords <- st_as_sf(muleys, coords = c("Long", "Lat"), crs = ll.crs)
plot(st_geometry(coords),axes=T)
deer.spdf <- st_crop(coords, xmin=-107.0,xmax=-110.5,ymin=37.8,ymax=39.0)
plot(st_geometry(deer.spdf),axes=T)

#Project deer.spdf to UTM to 
deer.utm <-st_transform(deer.spdf, crs=st_crs(crops))
plot(st_geometry(deer.utm),axes=T)

deer.utm.df <- as.data.frame(deer.utm)
deer.utm.xy <- st_coordinates(deer.utm)
 
muleys <- cbind(deer.utm.df,deer.utm.xy)
#Remove utm xys if needed
muleys <- muleys[c(-9:-10)]
#Only use the 5 lines of code below to subsample for demonstration purposes!
onemuley <-muleys[1:5,]
twomuley <-muleys[202:206,]
shortmd <- rbind(onemuley, twomuley)
muleys <- shortmd
```

6\. Next we need to create a function to extract Fragstats metrics within individual polygons

```{r eval=FALSE}
buff3rd <- function(muleys) {
  coords <- st_as_sf(muleys, coords = c("X", "Y"), crs = utm.crs)
  settbuff <- st_buffer(coords,1000) %>% st_as_sfc()
  settbuff <- vect(settbuff)
  buffclip <- mask(rc, settbuff)
  buff.data <- calculate_lsm(buffclip)
  newline <- coords$id
  bind <-cbind(newline[1], buff.data)
}

results <- ddply(muleys, .(id), buff3rd)
results
class(results)
```

7\. Code above looks at patch and class metrics for each deer by combining all buffers into one polygon for each deer (i.e., comparable to defining available habitat in 3rd order selection. However, what if we wanted to compare difference in patch statistics among all deer by averaging metrics across buffers?

```{r eval=FALSE}
coords<-data.frame(x = muleys$X, y = muleys$Y)
deer.spdf <- SpatialPointsDataFrame(coords=coords, data = muleys, proj4string = utm12.crs)
setbuff <- gBuffer(deer.spdf, width=1000, byid=TRUE)
muleys$newID <- paste(muleys$id, setbuff@plotOrder, sep="_")
muleys$newID <- as.factor(muleys$newID)

buff3rdA <- function(muleys) {
  bufclip <- mask(rc, setbuff)
  buf.data <- PatchStat(bufclip)
}

results2 <- ddply(muleys, .(newID), buff3rdA)
results2
```
